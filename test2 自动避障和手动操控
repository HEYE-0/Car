#include <iostream>
#include <termios.h>
#include <fcntl.h>
#include <unistd.h>

using namespace std;

int openSerialPort(const char* portName) {
    int serial = open(portName, O_RDWR | O_NOCTTY | O_SYNC);
    if (serial < 0) {
        perror("âŒ Failed to open serial port");
        return -1;
    }

    struct termios tty;
    if (tcgetattr(serial, &tty) != 0) {
        perror("tcgetattr failed");
        close(serial);
        return -1;
    }

    cfsetospeed(&tty, B9600);
    cfsetispeed(&tty, B9600);
    tty.c_cflag = (tty.c_cflag & ~CSIZE) | CS8;
    tty.c_iflag &= ~IGNBRK;
    tty.c_lflag = 0;
    tty.c_oflag = 0;
    tty.c_cc[VMIN] = 0;
    tty.c_cc[VTIME] = 5;
    tty.c_iflag &= ~(IXON | IXOFF | IXANY);
    tty.c_cflag |= (CLOCAL | CREAD);
    tty.c_cflag &= ~(PARENB | PARODD);
    tty.c_cflag &= ~CSTOPB;
    tty.c_cflag &= ~CRTSCTS;

    if (tcsetattr(serial, TCSANOW, &tty) != 0) {
        perror("tcsetattr failed");
        close(serial);
        return -1;
    }

    return serial;
}

int main() {
    const char* port = "/dev/ttyACM0";  // ä¿®æ”¹ä¸ºä½ çš„ä¸²å£å
    int serial = openSerialPort(port);
    if (serial < 0) return 1;

    cout << "âœ… Connected to Arduino on " << port << endl;
    cout << "ðŸŽ® Controls: w/a/s/d/q = movement | o = manual mode | p = auto avoid | x = exit" << endl;

    while (true) {
        cout << "\nEnter command > ";
        char cmd;
        cin >> cmd;

        if (cmd == 'x') break;

        if (cmd == 'w' || cmd == 'a' || cmd == 's' || cmd == 'd' ||
            cmd == 'o' || cmd == 'p' || cmd == 'q') {
            write(serial, &cmd, 1);
            cout << "âž¡ï¸ Sent command: " << cmd << endl;
        } else {
            cout << "âš ï¸ Invalid command." << endl;
        }
    }

    close(serial);
    cout << "ðŸ”Œ Serial port closed." << endl;
    return 0;
}
