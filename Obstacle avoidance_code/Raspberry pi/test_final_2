#include <iostream>
#include <thread>
#include <chrono>
#include <fcntl.h>
#include <termios.h>
#include <unistd.h>
#include <string>
#include <atomic>
#include <csignal>

using namespace std;

int serial_port;
atomic<bool> running(true);

// åˆå§‹åŒ–ä¸²å£
bool setupSerial(const string& port_name = "/dev/ttyACM0", int baud_rate = B9600) {
    serial_port = open(port_name.c_str(), O_RDWR);
    if (serial_port < 0) {
        perror("âŒ Cannot open serial port");
        return false;
    }

    termios tty;
    tcgetattr(serial_port, &tty);
    tty.c_cflag = baud_rate | CS8 | CLOCAL | CREAD;
    tty.c_iflag = IGNPAR;
    tty.c_oflag = 0;
    tty.c_lflag = 0;
    tty.c_cc[VTIME] = 0;
    tty.c_cc[VMIN] = 1;
    tcflush(serial_port, TCIFLUSH);
    tcsetattr(serial_port, TCSANOW, &tty);

    return true;
}

// å‘é€å‘½ä»¤
void sendCommand(char cmd) {
    write(serial_port, &cmd, 1);
}

// è¯»å– Arduino çš„è·ç¦»ä¿¡æ¯
void readArduino() {
    char buf[256];
    while (running) {
        int n = read(serial_port, buf, sizeof(buf) - 1);
        if (n > 0) {
            buf[n] = '\0';
            cout << buf;
            cout.flush();
        }
    }
}

// è®¾ç½®ç»ˆç«¯ä¸ºéé˜»å¡ã€éå›æ˜¾æ¨¡å¼
void enableKeyboardInput(termios& oldt) {
    termios newt;
    tcgetattr(STDIN_FILENO, &oldt);
    newt = oldt;
    newt.c_lflag &= ~(ICANON | ECHO);  // å…³é—­æ ‡å‡†è¾“å…¥æ¨¡å¼å’Œå›æ˜¾
    tcsetattr(STDIN_FILENO, TCSANOW, &newt);
}

// æ¢å¤ç»ˆç«¯æ¨¡å¼
void restoreKeyboardInput(const termios& oldt) {
    tcsetattr(STDIN_FILENO, TCSANOW, &oldt);
}

// å¤„ç† Ctrl+C ä¿¡å·
void handleSignal(int signal) {
    running = false;
    close(serial_port);
    cout << "\nğŸšª ç¨‹åºå·²é€€å‡ºã€‚\n";
    exit(0);
}

int main() {
    signal(SIGINT, handleSignal); // æ•è· Ctrl+C

    if (!setupSerial()) return 1;
    this_thread::sleep_for(chrono::seconds(2)); // ç­‰å¾… Arduino å¯åŠ¨

    sendCommand('p'); // åˆå§‹è‡ªåŠ¨æ¨¡å¼
    cout << "ğŸš— è‡ªåŠ¨é¿éšœæ¨¡å¼å·²å¯åŠ¨ (æŒ‰ m åˆ‡æ¢æ‰‹åŠ¨)\n";

    // å¼€çº¿ç¨‹è¯»å– Arduino ä¿¡æ¯
    thread reader(readArduino);

    termios oldt;
    enableKeyboardInput(oldt);

    while (running) {
        char key;
        if (read(STDIN_FILENO, &key, 1) == 1) {
            switch (key) {
                case 'w': sendCommand('w'); cout << "â†‘ å‰è¿›\n"; break;
                case 's': sendCommand('s'); cout << "â†“ åé€€\n"; break;
                case 'a': sendCommand('a'); cout << "â† å·¦è½¬\n"; break;
                case 'd': sendCommand('d'); cout << "â†’ å³è½¬\n"; break;
                case 'q': sendCommand('q'); cout << "â›” åœæ­¢\n"; break;
                case 'p': sendCommand('p'); cout << "ğŸš— è‡ªåŠ¨æ¨¡å¼å¯åŠ¨\n"; break;
                case 'm': sendCommand('o'); cout << "ğŸ® æ‰‹åŠ¨æ¨¡å¼å¯åŠ¨\n"; break;
                case 27:  // ESC
                    running = false;
                    cout << "ğŸ›‘ ESC é€€å‡ºç¨‹åº\n";
                    break;
            }
        }
        this_thread::sleep_for(chrono::milliseconds(50));
    }

    reader.join();
    restoreKeyboardInput(oldt);
    close(serial_port);
    return 0;
}
