#include <iostream>
#include <fstream>
#include <string>
#include <thread>
#include <chrono>
#include <fcntl.h>
#include <termios.h>
#include <unistd.h>

using namespace std;

// ä¸²å£è·¯å¾„ï¼ˆå¯æŒ‰éœ€ä¿®æ”¹ï¼‰
const char* SERIAL_PORT = "/dev/ttyUSB0";  // æˆ– "/dev/ttyAMA0"ã€"/dev/serial0"

int openSerial(const char* port) {
    int serial = open(port, O_RDWR | O_NOCTTY | O_NDELAY);
    if (serial == -1) {
        cerr << "âŒ æ— æ³•æ‰“å¼€ä¸²å£ " << port << endl;
        return -1;
    }

    struct termios options;
    tcgetattr(serial, &options);
    cfsetispeed(&options, B9600);  // æ³¢ç‰¹ç‡
    cfsetospeed(&options, B9600);

    options.c_cflag |= (CLOCAL | CREAD);    // å¯åŠ¨ä¸²å£æ¥æ”¶
    options.c_cflag &= ~PARENB;             // æ— æ ¡éªŒ
    options.c_cflag &= ~CSTOPB;             // 1ä½åœæ­¢ä½
    options.c_cflag &= ~CSIZE;
    options.c_cflag |= CS8;                 // 8ä½æ•°æ®ä½
    options.c_lflag &= ~(ICANON | ECHO | ECHOE | ISIG);  // åŸå§‹æ¨¡å¼
    options.c_oflag &= ~OPOST;              // åŸå§‹è¾“å‡ºæ¨¡å¼

    tcsetattr(serial, TCSANOW, &options);
    return serial;
}

void sendCommand(int serial, char cmd) {
    write(serial, &cmd, 1);
    cout << "ğŸ“¤ å·²å‘é€å‘½ä»¤ï¼š" << cmd << endl;
}

void readFromArduino(int serial) {
    char buf[256];
    int len;

    while (true) {
        len = read(serial, buf, sizeof(buf) - 1);
        if (len > 0) {
            buf[len] = '\0';
            cout << "ğŸ“¥ Arduinoå›ä¼ ï¼š" << buf;
        }
        this_thread::sleep_for(chrono::milliseconds(100));
    }
}

int main() {
    int serial = openSerial(SERIAL_PORT);
    if (serial == -1) return 1;

    cout << "âœ… ä¸²å£è¿æ¥æˆåŠŸï¼š" << SERIAL_PORT << endl;

    // 1. ç­‰å¾… Arduino å¯åŠ¨
    this_thread::sleep_for(chrono::seconds(2));

    // 2. åˆ‡æ¢è‡³è‡ªåŠ¨é¿éšœæ¨¡å¼ï¼ˆå‘é€ 'p'ï¼‰
    sendCommand(serial, 'p');

    // 3. å¯åŠ¨åå°çº¿ç¨‹è¯»å– Arduino è¾“å‡º
    thread reader(readFromArduino, serial);

    // 4. ä¸»çº¿ç¨‹ä¿æŒè¿è¡Œï¼ˆå¯æ‹“å±•ä¸ºé”®ç›˜é¥æ§ç­‰ï¼‰
    while (true) {
        this_thread::sleep_for(chrono::seconds(1));
        // å¯æ·»åŠ ç½‘é¡µäº¤äº’ã€å®šæ—¶ä»»åŠ¡ç­‰é€»è¾‘
    }

    // ä¸ä¼šæ‰§è¡Œåˆ°è¿™ä¸€æ­¥ï¼Œä½†å»ºè®®å®Œæ•´æ€§
    reader.join();
    close(serial);
    return 0;
}
